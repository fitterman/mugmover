- thumbsize = 50
- thumbsizeWithBorder = thumbsize + 2

:css
  .picturethumb { z-index: 2; display: inline-flex; 
                  width: #{thumbsizeWithBorder}px; height: #{thumbsizeWithBorder}px; 
                  background-size: contain; background-color: white;
                  border: 2px solid white; 
                }
  .unselected   { opacity: 0.5; }
  .selected     { background-color: red; border: 2px solid red; opacity: 1.0; }
  .enlarged     { z-index: 3; opacity: 1.0; 
                  width: #{2 * thumbsizeWithBorder}px; height: #{2 * thumbsizeWithBorder}px; }
  #picturebar-container::-webkit-scrollbar { -webkit-appearance: none; height: 10px; width: 0px; }
  #picturebar-container::-webkit-scrollbar-track { background-color: rgba(0, 0, 0, .2);  
                                                   border: 1px solid silver; 
                                                   border-radius: 10px; }
  #picturebar-container::-webkit-scrollbar-thumb { border-radius: 8px; background-color: rgba(0, 0, 0, .4); }

.row
  %p#notice= notice

.row#picturebar-container{style: 'height: 114px; overflow-y: scroll; white-space: nowrap;'}
  #picturebar{style: "position:relative;" }

.row{style: 'margin: 1em;'}
  .col-xs-8
    %button.btn.btn-primary{id: 'photoButton' }
      Photo
    %button.btn.btn-primary{id: 'detailsButton' }
      Details
  .col-xs-4
    %span.glyphicon.glyphicon-flag.pull-right{style: 'font-size: 140%;', 'aria-label' => 'not flagged'}

.jumbotron
  #picture-container{style: 'position: relative; margin-left: auto; margin-right: auto;'}
    
:plain
  <script type="text/template" id="photos-template-text">
    <% _.each(photos, function(photo) { %>
      <% if ($('.picturethumb[phid=' + photo.get('id') + ']').length == 0) { %>
          <div class="picturethumb unselected" style="position: absolute; 
              background-repeat: no-repeat; background-position: center; 
              background-image: url('<%- photo.get('thumb') %>');
              top: 27px;
              left: <%- i2x(photo.get('index')) %>px;" 
              phw="<%- photo.get('scaled_w') %>"
              phh="<%- photo.get('scaled_h') %>"
              phid="<%- photo.get('id') %>">
          </div>
      <% }; %>
    <% }); %>
    <% var rightX = $('#picturebar-container').scrollLeft() + $('#picturebar-container').width(); %>
    <% var rightN = Math.floor(x2i(rightX) / photosPerRequest); %>
    <% var currentN = Math.floor(photos[photos.length-1].get('index') / photosPerRequest); %>
    <% if ((currentN < rightN) && (currentN < lastRequestN)) { %>
      <% photoList.render({a_id: '#{params[:a_id]}', n: currentN + 1}); %>
    <% }; %>
  </script>

  <script type="text/template" id="photo-template-text">
    <img src=<%- photo.get('url') %> 
         style="z-index: 1; position: absolute; top: 0; left: 0; max-width:500px; max-height:500px;">
    <% var notes = photo.get('notes'); %>
    <% for (var i = 0, len = notes.length; i < len; i++) { %>
        <div class="floating" style="z-index: 110; position: absolute; border: 2px solid blue;
            left: <%- notes[i].x %>px; top: <%- notes[i].y %>px;
            width: <%- notes[i].w %>px; height: <%- notes[i].h %>px;" 
            data-caption="<%- notes[i].text %>">
          <div class="caption" style="opacity: 0.6; z-index: 108; white-space: nowrap; position: absolute; bottom: -2em; background-color: beige;
                                      padding-left: 0.5em; padding-right: 0.5em;  border-radius: 3px; ">
            <%- notes[i].known ? notes[i].text : 'unknown' %>
          </div>
        </div>

    <% }; %>
    </img>
  </script>

  <script type="text/template" id="photo-details-template-text">
    <pre><%- JSON.stringify(photo.get('request'), null, 4) %></pre> 
  </script>

:javascript
  var endGap = 400; // pixels
  var photoWidth = #{thumbsizeWithBorder}; // pixels (2px on each side)
  var totalPhotos = #{@total_photos};
  var photosPerRequest = #{Api::V1::PicsController::PAGESIZE};
  var lastRequestN = Math.floor(totalPhotos  / photosPerRequest);
  var currentPhoto;
  
  // functions to convert a zero-based index to a horizontal pixel offset and back.
  var i2x = function(i) { return endGap + (i * photoWidth) };
  var x2i = function(x) { return Math.floor(Math.max(0, x - endGap) / photoWidth) };

  // function to align the flag color with its current state
  var setFlagColor = function(newState) {
    var obj = $('.glyphicon-flag');
    $(obj).css({color:  newState ? 'purple' : 'gray' })
          .attr('aria-label', newState ? 'flagged' : 'not flagged');
  }
  // function to align the flag state and set its color
  var toggleFlagSetting = function()
  {
    var currentState = $.inArray(currentPhoto.attributes.flag, [1, true]) != -1;
    setFlagColor(!currentState);
    return !currentState;
  }

  var setFlagAtServer = function(newValue)
  {
    $.ajax({
             url: "#{flag_api_v1_pics_url}",
             data: {a_id: '#{params[:a_id]}', id: currentPhoto.attributes.id, flag: newValue ? 1 : 0},
             type: 'POST',
             error: function()
             {
               alert("The mugmover server failed to mark the request");
             },
             success: function(data)
             {
               currentPhoto.attributes.flag = data.photo.flag
             },
             complete: function()
             {
               var currentState = currentPhoto.attributes.flag; // restore the flag state
               setFlagColor(currentState);
             }

           });   
  }

  $('button#photoButton').on('click', function() {  router.navigate('show/' + currentPhoto.id , {trigger: true}); });
  $('button#detailsButton').on('click', function() {  router.navigate('details/' + currentPhoto.id , {trigger: true}); });
  $('.glyphicon-flag').on('click', function() {
    var newState = toggleFlagSetting();
    setFlagAtServer(newState);
  });
  $('#picturebar').width(i2x(totalPhotos) + endGap); // that is the endGap on the RHS
  $('#picture-container').on('mouseover', '.floating', function() {
    $(this).css({'border-color': 'red', 'z-index': '112' }).children('.caption').css({opacity: 1.0, 'z-index': '112'});
  })
  $('#picture-container').on('mouseout', '.floating', function() {
    $(this).css({'border-color': 'blue', 'z-index': '110' }).children('.caption').css({opacity: 0.6, 'z-index': '108'});
  });

  var scrollingDone = function() {
    var x = $('#picturebar-container').scrollLeft();
    var i = x2i(x);
    photoList.render({a_id: '#{params[:a_id]}', n: Math.floor(i / photosPerRequest)}); 
  };
  $('#picturebar-container').scroll( $.debounce( 250, scrollingDone) );

  $('#picturebar').on('mouseover', '.picturethumb', function() {
    $(this).addClass('enlarged').css({ top: $(this).position().top - #{thumbsizeWithBorder / 2},
                                       left: $(this).position().left - #{thumbsizeWithBorder / 2}});
                                     });
  $('#picturebar').on('mouseout', '.picturethumb', function() {
    $(this).removeClass('enlarged').css({ top: $(this).position().top + #{thumbsizeWithBorder / 2},
                                          left: $(this).position().left + #{thumbsizeWithBorder / 2}});
                                        });
  $('#picturebar').on('click', '.picturethumb', function() {
    $('#picturebar > .selected').removeClass('selected').addClass('unselected');
    // TODO Fill in with the image you have. Requires knowing the AR of the photo 
      $('#picture-container').html('&nbsp;').css({'background-image': $(this).css('background-image'), 
                                                  "background-size": 'contain', 
                                                  "background-repeat": 'none',
                                                  "background-color": 'white',
                                                  'width': $(this).attr('phw'),
                                                  'height': $(this).attr('phh')});
    //                                      .css(parseFloat($(this).attr("ar")) > 1.0 ? 'width' : 'height', "500px");
    $(this).removeClass('unselected').addClass('selected');
    router.navigate('show/' + $(this).attr('phid') , {trigger: true});
  });

  var Photos = Backbone.Collection.extend({
    url: "#{api_v1_pics_path(format: 'json')}"
  });
  var Photo = Backbone.Model.extend({
    url: function() {return "#{api_v1_pics_path}/" + this.attributes.id + '.json?a_id=' + this.attributes.a_id},
  });
  var PhotoDetails = Backbone.Model.extend({
    url: function() {return "#{details_api_v1_pics_path}" + '.json?a_id=' + this.attributes.a_id + '&id=' + this.attributes.id},
  });

  var PhotoList = Backbone.View.extend({
    el: '#picturebar',
    render: function(options) {
      var photos =  new Photos();
      var that = this;
      photos.fetch({
        data: { n: options.n, a_id: options.a_id },
        error: function(photos) {
          alert('An unexpected error occurred. Please try again.');
        },
        success: function(photos) {
          var template = _.template($('#photos-template-text').html());
          var html = template({ photos: photos.models });
          that.$el.append(html);
          return this;
        }
      })
      
    }
  });
  var ShowPhoto = Backbone.View.extend({
    el: '#picture-container',
    render: function(options) {
      currentPhoto = new Photo({a_id: options.a_id, id: options.id});
      var that = this;
      currentPhoto.fetch({
        error: function(photos) {
          alert('An unexpected error occurred. Please try again.');
        },
        success: function(photo) {
          var template = _.template($('#photo-template-text').html());
          var html = template({photo: photo});
          that.$el.html(html);
          setFlagColor(currentPhoto.attributes.flag);
          if ($('#picturebar').html() == "")
          {
            photoList.render({a_id: options.a_id, n: 0});
          }
          return this;
        }        
      })
    }
  });

  var ShowPhotoDetails = Backbone.View.extend({
    el: '#picture-container',
    render: function(options) {
      var photoDetails = new PhotoDetails({a_id: options.a_id, id: options.id});
      var that = this;
      photoDetails.fetch({
        error: function(photos) {
          alert('An unexpected error occurred. Please try again.');
        },
        success: function(photo) {
          var template = _.template($('#photo-details-template-text').html());
          var html = template({photo: photo});
          that.$el.html(html).css({width: '100%'});
          //          setFlagColor(currentPhoto.attributes.flag);
          if ($('#picturebar').html() == "")
          {
            photoList.render({a_id: options.a_id, n: 0});
          }
          return this;
        }        
      })
    }
  });

  var Router = Backbone.Router.extend({
    routes: {
      '':         'home',
      'show/:id': 'show',
      'details/:id': 'details',
    }
  });

  var router = new Router();
  var photoList = new PhotoList();
  var showPhoto = new ShowPhoto();
  var showPhotoDetails = new ShowPhotoDetails();

  router.on('route:home', function() {
    photoList.render({a_id: #{params[:a_id]}, n: 0});
  });
  router.on('route:show', function(id) {
    showPhoto.render({a_id: #{params[:a_id]}, id: id})
  });
  router.on('route:details', function(id) {
    showPhotoDetails.render({a_id: #{params[:a_id]}, id: id})
  });
  Backbone.history.start();
